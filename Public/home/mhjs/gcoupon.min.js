/* 2017-12-20 17:12:34 */
var GCoupon={ver:'201712201730',small_html:'<div class="side-rp" id="gcoupon-small-container"><div class="container"><div class="time"></div><div class="action"><a href="javascript:void(0);"><i class="icon-close"></i></a></div></div></div>',expand_html:'<div class="mask-box gcoupon-expand-popup" style="display:none;"></div><div class="modal rpse-modal gcoupon-expand-popup" id="gcoupon-expand-container" style="display:none;"><div class="inner"><div class="rt"><div class="subject"></div><div class="cd" id="gcoupon-time-clock"></div></div><div class="body"><div class="subject"></div><div class="text"></div></div><div class="action"><a href="javascript:void(0);" class="btn confirm">立即使用</a><a href="javascript:void(0);" class="close cancel">关闭</a></div></div></div>',choice_pay_html:'<div class="mask-box gcoupon-choice-pay" style="display:none;"></div><div class="item2p choice-pay gcoupon-choice-pay" id="gcoupon-choice-pay" style="display:none;"><div class="inner"><div class="title"><strong>选择支付方式</strong></div><div class="close"><a href="javascript:void(0);"></a></div><div class="entry"><ul><li><a href="javascript:void(0);" data-paytype="wx"><i class="icon-wechat"></i>微信支付</a></li><li><a href="javascript:void(0);" data-paytype="alipay"><i class="icon-alipay"></i>支付宝支付</a></li></ul></div></div></div>',query_url:'/coupon/my_gcoupon_local',start_time:+(new Date),get_time:function(){return+(new Date);},message_list:[],getcookie:function(name){var nameValue="";var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");if(arr=document.cookie.match(reg)){nameValue=decodeURI(arr[2]);}
return nameValue;},compareDate:function(startTime,endTime){var curTime=new Date(),startTime=new Date(startTime.replace(/-/g,"\/")),endTime=new Date(endTime.replace(/-/g,"\/"));return(curTime>=startTime&&curTime<=endTime);},tips:function(msg,callback){$("body").append("<div id='gcoupon-tips' style='position:fixed;left:0;top:50%;z-index:100;text-align:center;width:100%'><span style='background: rgba(0, 0, 0, 0.65);color: #fff;padding: 10px 15px;border-radius: 3px; font-size: 14px;'>"+msg+"</span></div>");setTimeout(function(){$("#gcoupon-tips").remove();if(callback)callback();},2000);},nowPayQuery:false,jq_ajax:function(url,data,successCallBack){var random=+(new Date());data.param_random=random;$.ajax({type:"POST",dataType:"json",url:url,cache:false,data:data,timeout:5000,beforeSend:function(req){this.data+="&send_random="+random;req.setRequestHeader("Random",random);},success:function(json){try{successCallBack(json);}catch(e){window.console&&window.console&&console.log("动态请求js回调异常",e);}},error:function(xhr,type){GCoupon.logs('动态请求失败');window.console&&window.console&&console.log("动态请求失败记录",xhr,type);}});}};GCoupon.query=function(callback){GCoupon.data={show_coupon:0};GCoupon.jq_ajax(GCoupon.query_url,{random:GCoupon.get_time()},function(res){if(res.status==1){GCoupon.data=res.data;}
GCoupon.logs('优惠券查询结果返回');callback();})};GCoupon.destroy=function(){$("#gcoupon-small-container,.gcoupon-expand-popup").remove();setTimeout(function(){GCoupon=null;delete GCoupon;},2000);};GCoupon.time_end=function(that,type){var hour=0,minute=0,second=0,intDiff=0,endTime=GCoupon.data.coupon_end_time;var func=function(){intDiff=endTime-GCoupon.get_time(),intDiff=parseInt(intDiff/1000);if(intDiff<=0){clearInterval(that.attr('data-interval'));GCoupon.destroy();return false;}
if(intDiff>=0){hour=Math.floor(intDiff/3600);minute=Math.floor(intDiff/60)-(hour*60);second=Math.floor(intDiff)-(hour*3600)-(minute*60);}
if(hour<=9)hour='0'+hour;if(minute<=9)minute='0'+minute;if(second<=9)second='0'+second;if(type=='small'){if(hour>0){that.html(""+hour+":"+minute);}else{that.html(""+minute+":"+second);}}else{that.html("有效期：<strong>"+hour+"</strong>时<strong>"+minute+"</strong>分<strong>"+second+'</strong>秒');}};var time_end_interval=setInterval(func,1000);func();that.attr('data-interval',time_end_interval);};GCoupon.show_small=function(){if(GCoupon.getcookie("qrmh_gcoupon_"+GCoupon.data.coupon_id)){GCoupon.logs('不展示已经关闭过的优惠券');return;}
$("body").append(GCoupon.small_html);var that=$("#gcoupon-small-container");GCoupon.time_end(that.find('.time'),'small');that.find('.action a').click(function(){var weeTime=new Date();weeTime.setTime(weeTime.getTime()+(GCoupon.data.time_scale||43200)*1e3);document.cookie="qrmh_gcoupon_"+GCoupon.data.coupon_id+"=1;expires="+weeTime.toGMTString()+";path=/";clearInterval(that.find('.time').attr('data-interval'));GCoupon.destroy();GCoupon.logs('关闭了优惠券浮层，本优惠券不在展示');return false;});that.click(GCoupon.show_expand);GCoupon.logs('优惠券小红包展示完成');};GCoupon.show_expand=function(){$("body").append(GCoupon.expand_html);var coupon=GCoupon.data.coupon,popup=$("#gcoupon-expand-container");popup.find('.rt .subject').html('<strong>'+coupon.coupon_money+'</strong>元券');if(coupon.coupon_type==1){popup.find('.rt .cd').html('<strong>'+coupon.coupon_start+'</strong>至<strong>'+coupon.coupon_end+'</strong>');}else{popup.find('.rt .cd').html('有效期：<strong>9</strong>分<strong>9</strong>秒').addClass('gcoupon_time_clock');GCoupon.time_end($('#gcoupon-time-clock.gcoupon_time_clock'),'expand');}
popup.find('.body .subject').text('充'+coupon.coupon_money+'元送'+coupon.coupon_bean+'元');popup.find('.body .text').text(coupon.coupon_money+'元='+coupon.coupon_money+'00金币+送'+coupon.coupon_bean+'00金豆');popup.find('.action .cancel').click(function(){$(".gcoupon-expand-popup").remove();if($("#gcoupon-time-clock").hasClass('gcoupon_time_clock')){$("#gcoupon-time-clock").removeClass('gcoupon_time_clock');clearInterval($("#gcoupon-time-clock").attr('data-interval'));}
GCoupon.logs('关闭了展开的优惠券');});popup.find('.action .confirm').click(function(){var couponData=GCoupon.data.coupon;if(couponData.coupon_type==1&&!GCoupon.compareDate(couponData.coupon_start+' 00:00:00',couponData.coupon_end+' 23:59:59')){GCoupon.tips('券不在有效期内，不能充值');return false;}
$(".gcoupon-expand-popup").remove();if($("#gcoupon-time-clock").hasClass('gcoupon_time_clock')){$("#gcoupon-time-clock").removeClass('gcoupon_time_clock');clearInterval($("#gcoupon-time-clock").attr('data-interval'));}
GCoupon.logs('使用全局优惠券去下单');GCoupon.go_start_pay();});popup.add(".gcoupon-expand-popup").show();GCoupon.logs('优惠券展开完成');};GCoupon.checkandalipay=function(){GCoupon.logs('微信中支付宝支付');GCoupon.jq_ajax('/alipay/ajaxcoupon',{coupon_id:GCoupon.data.coupon_id,coupon_r:'gc',book_id:(window.bid||0),callback:encodeURI(window.location.href),p_u:(GCoupon.get_time()-GCoupon.start_time),random:+(new Date)},function(res){GCoupon.logs('微信中支付宝支付下单回调');if(res.status*1==1){GCoupon.payPackage=res.data;window.location.replace('/alipay/xpay?trade_id='+GCoupon.payPackage.trade_id+'&et='+GCoupon.payPackage.etoken);}else if(res.status*1==-2){GCoupon.tips("需要登录，请重新登录重试");}else if(res.status*1==-1){GCoupon.tips("选择的充值信息有误，请重新选择重试");}else if(res.status*1==0){GCoupon.tips("下单失败，请稍后重试");}else{GCoupon.tips(res.info);}});};GCoupon.checkandpay=function(){GCoupon.logs('微信中微信支付');GCoupon.jq_ajax('/wxpay/couponajax',{coupon_id:GCoupon.data.coupon_id,coupon_r:'gc',book_id:(window.bid||0),callback:encodeURI(window.location.href),p_u:(GCoupon.get_time()-GCoupon.start_time),random:+(new Date)},function(res){GCoupon.logs('微信中微信支付下单回调');if(res.status*1==1){GCoupon.payPackage=res.data;window.location.replace('https://w.efucms.com/wxpay/xpay?trade_id='+GCoupon.payPackage.trade_id);}else if(res.status*1==-2){GCoupon.tips("需要登录，请重新登录重试");}else if(res.status*1==-1){GCoupon.tips("选择的充值信息有误，请重新选择重试");}else if(res.status*1==0){GCoupon.tips("下单失败，请稍后重试");}else{GCoupon.tips(res.info);}});}
GCoupon.pageFocusQueryNowPay=function(){if(GCoupon.nowPayQuery){GCoupon.jq_ajax('/nowpay/ajax_query_coupon',GCoupon.payPackage,function(res){GCoupon.logs('浏览器中现在支付查询订单状态');if(res.status*1!=1){GCoupon.tips(res.info);return;}
if(res.payStatus>0){GCoupon.tips("支付成功");setTimeout(function(){window.location.reload();},500);return;}
GCoupon.tips("未支付成功");});}};GCoupon.visibilitychange=function(){GCoupon.srattime=GCoupon.get_time();GCoupon.difftime=0;GCoupon.logs('浏览器中现在支付绑定页面显隐事件');$(document).on('visibilitychange',function(e){if(e.target.visibilityState==="visible"){GCoupon.difftime=GCoupon.get_time()-GCoupon.srattime;GCoupon.srattime=GCoupon.get_time();setTimeout(function(){if(GCoupon.difftime>500)GCoupon.pageFocusQueryNowPay();},500);}else if(e.target.visibilityState==="hidden"){GCoupon.difftime=GCoupon.get_time()-GCoupon.srattime;GCoupon.srattime=GCoupon.get_time();}});};GCoupon.checkwithnowpay=function(){GCoupon.logs('浏览器中现在支付下单');GCoupon.jq_ajax('/nowpay/ajaxcoupon',{coupon_id:GCoupon.data.coupon_id,coupon_r:'gc',book_id:(window.bid||0),callback:encodeURI(window.location.href),p_u:(GCoupon.get_time()-GCoupon.start_time),random:+(new Date)},function(res){GCoupon.logs('浏览器中现在支付下单回调');if(res.status*1==1){GCoupon.payPackage=res.data;GCoupon.nowPayQuery=true;window.location.href=GCoupon.payPackage.weixin_url;if(!GCoupon.srattime)GCoupon.visibilitychange();}else if(res.status*1==-2){GCoupon.tips("需要登录，请重新登录重试");}else if(res.status*1==-1){GCoupon.tips("选择的充值信息有误，请重新选择重试");}else if(res.status*1==0){GCoupon.tips("下单失败，请稍后重试");}else{GCoupon.tips(res.info);}});};GCoupon.checkwithalipay=function(){GCoupon.logs('浏览器中支付宝支付');window.location.replace('/alipay/coupon?coupon_id='+(GCoupon.data.coupon_id)+'&coupon_r=gc&book_id='+(window.bid||0)+'&p_u='+(GCoupon.get_time()-GCoupon.start_time)+'&callback='+encodeURI(window.location.href));};GCoupon.go_start_pay=function(){var ua=navigator.userAgent.toLowerCase();if(ua.match(/MicroMessenger/i)=="micromessenger"){GCoupon.getcookie('qrmh_channel_mp')==1?GCoupon.checkandalipay():GCoupon.checkandpay();}else{GCoupon.choice_pay_box();}};GCoupon.choice_pay_box=function(){$("body").append(GCoupon.choice_pay_html);var choice_pay=$("#gcoupon-choice-pay");choice_pay.find('.close a').click(function(){GCoupon.logs('浏览器中关闭选择支付方式浮层');$(".gcoupon-choice-pay").remove();});choice_pay.find('.entry ul li a').click(function(){$(".gcoupon-choice-pay").remove();$(this).attr('data-paytype')=='wx'?GCoupon.checkwithnowpay():GCoupon.checkwithalipay();});choice_pay.add('.gcoupon-choice-pay').show();};GCoupon.logs=function(x){x=(GCoupon.get_time()-GCoupon.start_time)+'|'+x;GCoupon.message_list.push(x);window.console&&console.log&&console.log(x);};GCoupon.init=function(){GCoupon.query(function(){if(GCoupon.data.show_coupon){GCoupon.show_small();}else{GCoupon.logs('暂时没有可展示的优惠券');}
GCoupon.logs('全局优惠券初始化完毕[VER：'+GCoupon.ver+']');});};$(function(){GCoupon.init();})